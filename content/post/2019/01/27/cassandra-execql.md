---
title: "Cassandraにマルチスレッドでバッチ形式にCQLを実行するコマンドexecqlを作った"
date: 2019-01-29T22:00:00+09:00
draft: false
keywords: ["cassandra","golang","cobra"]
description: "Cassandraにマルチスレッドでバッチ形式にCQLを実行するコマンドexecqlを作った"
tags: ["golang","cassandra","cobra"]
categories: ["golang","cassandra"]
author: "ken-aio"
---

<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-normal" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

# はじめに
Cassandraを使っていて一括で大量にデータをinsertしたいケースがありました。  
Cassandra標準のcqlshを使うと、かなりの時間がかかったため、マルチスレッドで一括データ投入できるコマンドを作りました。  

このコマンドは前に記事を書いたGolangとcobraを使って実装しています。  

[[Golang]cobraを使って本格的なCLIを作る](https://ken-aio.github.io/post/2019/01/27/golang-cobra/)

# インストール
https://github.com/ken-aio/execql

ここにおいてあります。  
golangがあればgo getコマンドで、なければバイナリをダウンロードすることで利用可能です。  

# デモ
使っているコマンドのログをはっておきます。  
```
$ execql -k test-keyspace -f /path/to/exec.cql -n 10 -t 20
2019/01/27 00:02:50 Reading input cql file... /Users/s-akiho/Downloads/cql
2019/01/27 00:02:50 Complete reading input cql file
2019/01/27 00:02:50 Creating cassandra session...
2019/01/27 00:03:00 Complete creating cassandra session
2019/01/27 00:03:00 Execute CQL...
#0(227) 99% [===================================================================================================================================================================================================================] 7s
#1(227) 99% [===================================================================================================================================================================================================================] 6s
#2(227) 99% [===================================================================================================================================================================================================================] 7s
#3(227) 99% [===================================================================================================================================================================================================================] 7s
#4(227) 99% [===================================================================================================================================================================================================================] 6s
#5(227) 99% [===================================================================================================================================================================================================================] 6s
#6(227) 99% [===================================================================================================================================================================================================================] 6s
#7(227) 99% [===================================================================================================================================================================================================================] 6s
#8(227) 99% [===================================================================================================================================================================================================================] 6s
#9(227) 99% [===================================================================================================================================================================================================================] 7s
#10(227) 99% [==================================================================================================================================================================================================================] 7s
#11(227) 99% [==================================================================================================================================================================================================================] 7s
#12(227) 99% [==================================================================================================================================================================================================================] 6s
#13(227) 99% [==================================================================================================================================================================================================================] 6s
#14(227) 99% [==================================================================================================================================================================================================================] 7s
#15(227) 99% [==================================================================================================================================================================================================================] 6s
#16(227) 99% [==================================================================================================================================================================================================================] 6s
#17(227) 99% [==================================================================================================================================================================================================================] 6s
#18(227) 99% [==================================================================================================================================================================================================================] 6s
#19(224) 99% [==================================================================================================================================================================================================================] 6s
2019/01/27 00:03:07 Complete execute CQL
```

基本的にバッチ実行になるので、どれくらいのcqlが完了したか、進捗を表示するようにしています。  
進捗の表示については [multibar](http://github.com/sethgrid/multibar) というpluginを使わせていただきました。  
非常によくできており、multibarを使うと簡単に進捗を表示することができました。  

# 使い方
基本的にはコネクション数とスレッド数を指定して実行したいCQLが書いてあるファイルを指定するとバッチ実行できます。  
詳細はcobraが作ってくれたhelpを参照すると使い方がわかります。  
```
$ execql -h
execute cql command

Usage:
  execql [flags]
  execql [command]

Available Commands:
  help        Help about any command
  version     All software has versions. This is Goenum's.

Flags:
  -f, --file string       cql file path (required)
  -h, --help              help for execql
  -H, --host string       cassandra host. split ',' if many host. e.g.) cassandra01, cassandra02 (default "localhost")
  -k, --keyspace string   exec target keyspace (required)
  -n, --num-conns int     connection nums (default 10)
  -p, --password string   connection password
  -P, --port int          cassandra port (default 9042)
  -t, --thread int        concurrent query request thread num (default 1)
      --timeout int       query timeout(ms) (default 60000)
  -u, --user string       connection user
```

# まとめ
cobraを使ってCLIを作ってみました。  
非常に使いやすくて簡単にやりたいコマンドを作ることができました。  
これからも何かコマンドラインを作りたかったら活用させていただきます。  
